<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>refresh-load</title>
	<style media="screen">
		html {
			font-size: 62.5%;
			background: #efefef;
		}
		html, body, p, ul, li {
			margin: 0;
			padding: 0;
		}
		ul, li {
			list-style: none;
		}
		a {
			color: #333;
			text-decoration: none;
			font-size: 4.4rem;
		}
		.list-wrapper {
			width: 100%;
		}
		.list-data .item:first-child {
			border-top: 1px solid #ddd;
		}
		.list-data .item {
			border-bottom: 1px solid #ddd;
			background: #fff;
		}
		.list-data .item > a {
			font-size: 36px;
			padding: 5rem 2rem;
			display: block;
			height: 100%;
		}
	</style>
</head>

<body>

	<div class="list-wrapper" id="listWrapper">
		<ul class="list-data" id="listData" v-cloak>
			<li class="item" v-for="item in list">
				<a href="javascript: void(0);">{{ item.name }}</a>
			</li>
		</ul>
	</div>
	<script type="text/javascript" src="vue.min.js"></script>
	<script type="text/javascript">

		;(function (window, document) {
			// 常量
			var CONSTANTS = {
				REFRESH: 1,
				LOAD: 2,
				REFRESH_INDEX: 0,
				LOAD_INDEX: 1,
				TEXT_REFRESH_INIT: '下拉刷新',
				TEXT_REFRESH_START: '释放刷新',
				TEXT_REFRESH_LOADING: '正在刷新...',
				TEXT_REFRESH_DONE: '刷新完成',
				TEXT_LOAD_INIT: '正在加载...',
				TEXT_LOAD_DONE: '加载完成',
				TEXT_LOAD_NONE: '没有更多数据',
				TEXT_LOAD_EMPTY: '暂无数据',
				CLASSNAME_TIP_DROP: 'drop-refresh',
				CLASSNAME_TIP_PULL: 'pull-load',
				CLASSNAME_TIP_TEXT: 'tip-text',
				CLASSNAME_TIP_ICON: 'tip-icon',
				TYPES: [
					{ id: 1, name: 'Vertical' },
					{ id: 2, name: 'Horizontal' }
				],
				VALIDATOR_TYPES: {
					STRING: 1,
					NUMBER: 2,
					BOOLEAN: 3,
					ARRAY: 4,
					OBJECT: 5
				}
			}

			// 验证
			function dataType(value) {
				if (value === '' || value == null) return undefined;
				if (typeof value === 'string') {
					return CONSTANTS.VALIDATOR_TYPES.STRING;
				}
				if (typeof value === 'number') {
					return CONSTANTS.VALIDATOR_TYPES.NUMBER;
				}
				if (typeof value === 'boolean') {
					return CONSTANTS.VALIDATOR_TYPES.BOOLEAN;
				}
				if (typeof value === 'object' && value.length) {
					return CONSTANTS.VALIDATOR_TYPES.ARRAY;
				}
				if (typeof value === 'object' && value.length) {
					return CONSTANTS.VALIDATOR_TYPES.OBJECT;
				}

				return undefined;
			}

			// 类继承
			function extend(Child, Parent) {
				var F = function () {};
				F.prototype = Parent.prototype;
				Child.prototype = new F();
				Child.prototype.constructor = Child;
				Child.uber = Parent.prototype;
			}

			// 参数初始化
			function optionsInit(options) {
				var _t = undefined;
				var opts = options || {};

				opts._type = opts.type || CONSTANTS.TYPES[0].id;
				_t = CONSTANTS.TYPES.find(x => x.id === opts._type);
				opts._type = _t ? _t.id : CONSTANTS.TYPES[0].id;
				opts.loadType = _t ? _t.name : CONSTANTS.TYPES[0].name;

				// Styles
				opts.styles = opts.styles ? opts.styles = {
					width: opts.styles.width || '100%',
					height: opts.styles.height || '200px',
					background: opts.styles.background || '#fff',
					color: opts.styles.color || '#000',
					fontSize: opts.styles.fontSize || '14px',
					icon: opts.styles.icon || ['./src/img/reload.png', './src/img/rolling.gif'],
					iconSize: opts.styles.iconSize || '50px',

				} : {
					width: '100%',
					height: '200px',
					background: '#fff',
					color: '#000',
					fontSize: '14px',
					icon: ['./src/img/reload.png', './src/img/rolling.gif'],
					iconSize: '50px',

				};

				// Refresh
				opts.refresh = opts.refresh ? opts.refresh = {
					use: opts.refresh.use === false ? opts.refresh.use : true,

				} : {
					use: true,

				}
				// Load
				opts.load = opts.load ? opts.load = {
					use: opts.load.use === false ? opts.load.use : true,

				} : {
					use: true,

				}

				return opts;
			}

			// 私有方法
			function styleDataType(style, index) {
				if (dataType(style) === CONSTANTS.VALIDATOR_TYPES.STRING
				   	|| dataType(style) === CONSTANTS.VALIDATOR_TYPES.NUMBER
			   	) {
					return style;
				}
				if (dataType(style) === CONSTANTS.VALIDATOR_TYPES.ARRAY) {
					return style[index];
				}
			}

			// 基类 - 公共属性
			function SuperLoad(options) {
				var self = this;
				var time_start = 0;

				this.options = options;
				this.time_interval = 0;
				this.move_start = 0;
				this.move_end = 0;

				// Methods
				this._create = function (index, text, classname) {
					var span = document.createElement('span');
					var span_text = document.createTextNode(text);
					var icon = document.createElement('i');
					var icon_size = styleDataType(this.options.styles.iconSize, index);

					span.className = classname;
					span.style.cssText = 'display: flex;justify-content: center;align-items: center;overflow: hidden;';
					icon.style.cssText = 'display: inline-block;text-align: center;width: ' + icon_size + ';height: ' + icon_size + ';margin-right: 1%;transition: transform .3s linear;';

					// Custom Styles
					for (var i in this.options.styles) {
						span.style[i] = styleDataType(this.options.styles[i], index);
					}
					icon.style.background = 'url("' + styleDataType(this.options.styles.icon, index) + '") no-repeat center/100%';

					// Reset Styles
					if (index === CONSTANTS.REFRESH_INDEX) span.style.height = '0px';
					// span.style.display = 'none';

					span.appendChild(icon);
					span.appendChild(span_text);

					return span;
				}

				this._handleTouchEvent = function (event) {
					var touch = event.touches[0],
						touched = event.changedTouches[0];

                    switch (event.type) {
                        case 'touchstart':
                            time_start = +new Date;
                            self.time_interval = 0;
                            if (self.options._type === CONSTANTS.TYPES[0].id) {
                            	self.move_start = touch.clientY;
                            	self._getPosition('touchstart', touch.clientY);
                            }
                            if (self.options._type === CONSTANTS.TYPES[1].id) {
                            	self.move_start = touch.clientX;
                            	self._getPosition('touchstart', touch.clientX);
                            }
                            break;
                        case 'touchend':
                            self.time_interval = +new Date - time_start;
                            if (self.options._type === CONSTANTS.TYPES[0].id) {
                            	self.move_end = touched.clientY;
                            	self._getPosition('touchend', touched.clientY);
                            }
                            if (self.options._type === CONSTANTS.TYPES[1].id) {
                            	self.move_end = touched.clientX;
                            	self._getPosition('touchend', touched.clientX);
                            }
                            break;
                        case 'touchmove':
                            event.preventDefault();
                            if (self.options._type === CONSTANTS.TYPES[0].id) {
                            	self._getPosition('touchmove', touched.clientY);
                            }
                            if (self.options._type === CONSTANTS.TYPES[1].id) {
                            	self._getPosition('touchmove', touched.clientX);
                            }
                            break;
                    }
				}

				this._getPosition = function (touchType, move) {
					console.log(touchType, move);
					console.log(this.move_start, this.move_end);

					var height = this.move_end - this.move_start;

					if (height > 0) {
						
					}
				}
			}

			SuperLoad.prototype.createRefresh = function () {
				var refresh = this._create(CONSTANTS.REFRESH_INDEX,
					CONSTANTS.TEXT_REFRESH_INIT,
					CONSTANTS.CLASSNAME_TIP_DROP);

				this.options.container.insertBefore(refresh, this.options.container.childNodes[0]);

				console.log(refresh)
			}

			SuperLoad.prototype.createLoad = function () {
				var load = this._create(CONSTANTS.LOAD_INDEX,
					CONSTANTS.TEXT_LOAD_INIT,
					CONSTANTS.CLASSNAME_TIP_PULL);


				this.options.container.appendChild(load);

				console.log(load)
			}

			SuperLoad.prototype.touchBind = function () {
				this.options.container.addEventListener("touchstart", this._handleTouchEvent, false);
                this.options.container.addEventListener("touchend", this._handleTouchEvent, false);
                this.options.container.addEventListener("touchmove", this._handleTouchEvent, false);
			}


			// 工厂方法
			function Factory(type, options) {
				if (this instanceof Factory) {
					// 继承基类
					extend(this[type], SuperLoad);

					return new this[type](options);
				} else {
					return new Factory(type, options);
				}
			}

			Factory.prototype = {
				// 纵向
				// 下拉刷新 上拉加载
				Vertical: function (options) {
					SuperLoad.call(this, options);

					console.log(this.options);

					this.options.refresh.use ? this.createRefresh() : '';
					this.options.load.use ? this.createLoad() : '';

					this.touchBind();
				},
				// 横向
				// 右拉刷新 左拉加载
				Horizontal: function (options) {
					SuperLoad.call(this, options);

					console.log(this.options);

					this.options.refresh.use ? this.createRefresh() : '';
					this.options.load.use ? this.createLoad() : '';

					this.touchBind();
				}
			}

			// 暴露对象
			var DropPullLoad = {
				on: function (target, options) {
					if (!target) return;

					var list = document.getElementById(target);
					if (!list) throw new Error('TabPageScroll ERR! config error');

					options.container = list;
					var opts = optionsInit(options);

					var load = new Factory(opts.loadType, opts);

				}
			}

			window.DropPullLoad = DropPullLoad;

		})(window, document);

	</script>
	<script type="text/javascript">
		var vm = new Vue({
			el: '#listWrapper',
			data: function () {
				return {
					list: [],
					total: 0,
					scroll: null
				}
			},
			methods: {
				get: function () {
					setTimeout(() => {
						const data = {
							items: [
								{ name: '1' },
								{ name: '2' },
								{ name: '3' },
								{ name: '4' },
								{ name: '5' },
								{ name: '6' },
								{ name: '7' },
								{ name: '8' },
								{ name: '9' }
							],
							total: 100
						}
						this.load(data);
					}, 1000);
				},
				load: function (result) {
					result.items.forEach(item => {
						this.list.push(item);
					});
					this.total = result.total;

					this.$nextTick(() => {
						DropPullLoad.on('listData', {
							type: 1,
							styles: {
								fontSize: '24px'
							},
							refresh: {
								use: true
							},
							load: {
								use: true
							}
						});
					});
				}
			},
			mounted: function () {
				this.get();
			}
		});
	</script>
</body>
</html>
